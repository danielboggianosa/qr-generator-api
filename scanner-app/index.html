<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BNI Ikigai QR Scanner</title>
        <link rel="manifest" href="/ikigai-qr-scanner/manifest.json">
        <link rel="icon" href="/ikigai-qr-scanner/icon.png" type="image/png">
        <meta name="theme-color" content="#D40000">
        <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/ikigai-qr-scanner/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful');
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
        </script>
        <style>
            :root {
                --bni-red: #D40000;
                --bni-black: #121117;
                --bni-white: #ffffff;
                --bg-color: #f5f5f5;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                background-color: var(--bg-color);
                color: var(--bni-black);
            }

            header {
                background-color: var(--bni-red);
                color: var(--bni-white);
                width: 100%;
                padding: 15px 0;
                text-align: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                margin-bottom: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            footer {
                margin-top: auto;
                padding: 15px;
                text-align: center;
                color: var(--bni-white);
                background-color: var(--bni-red);
                width: 100%;
                box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
                font-size: 0.8rem;
                font-weight: 600;
            }

            h1 {
                margin: 0;
                font-size: 1.5rem;
                font-weight: 600;
            }

            #reader {
                width: 90%;
                max-width: 500px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                background: white;
                margin-bottom: 20px;
            }

            #result-container {
                margin-top: 10px;
                text-align: center;
                display: none;
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 85%;
                max-width: 450px;
            }

            h3 {
                color: var(--bni-red);
                margin-top: 0;
            }

            #qrResult {
                font-size: 1em;
                color: #333;
                word-break: break-all;
                margin-bottom: 20px;
                padding: 15px;
                background: #f9f9f9;
                border-radius: 8px;
                border-left: 4px solid var(--bni-red);
                text-align: left;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1em;
                font-weight: 600;
                transition: all 0.2s ease;
                margin: 8px;
                width: 100%;
                max-width: 200px;
            }

            .btn-approve {
                background-color: var(--bni-red);
                color: white;
            }

            .btn-approve:hover {
                background-color: #a01314;
                transform: translateY(-1px);
            }

            .btn-scan-again {
                background-color: white;
                color: var(--bni-black);
                border: 2px solid #ddd;
            }

            .btn-scan-again:hover {
                background-color: #f0f0f0;
                border-color: #ccc;
            }

            /* Scanner customization */
            #html5-qrcode-button-camera-permission {
                background-color: var(--bni-red) !important;
                color: white !important;
                border: none !important;
                padding: 10px 20px !important;
                border-radius: 5px !important;
                font-weight: bold !important;
            }

            #html5-qrcode-anchor-scan-type-change {
                color: var(--bni-red) !important;
                text-decoration: none !important;
            }

            .btn-install {
                background-color: white;
                color: var(--bni-red);
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                margin-top: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                transition: transform 0.2s;
            }

            .btn-install:hover {
                transform: scale(1.05);
            }

            /* Tabs */
            .tab-container {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
                width: 90%;
                max-width: 500px;
            }

            .tab-btn {
                background: #e0e0e0;
                color: #333;
                border: none;
                padding: 10px 20px;
                border-radius: 20px;
                cursor: pointer;
                font-weight: 600;
                flex: 1;
                transition: all 0.3s;
            }

            .tab-btn.active {
                background: var(--bni-red);
                color: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }

            /* Search Styles */
            #search-container {
                width: 90%;
                max-width: 500px;
                display: none;
                /* Hidden by default */
                flex-direction: column;
                align-items: center;
            }

            .search-box {
                display: flex;
                width: 100%;
                gap: 10px;
                margin-bottom: 20px;
            }

            .search-input {
                flex: 1;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 1rem;
            }

            .search-btn {
                background: var(--bni-red);
                color: white;
                border: none;
                padding: 0 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
            }

            #search-results-list {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .result-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: transform 0.2s;
                border-left: 5px solid transparent;
            }

            .result-item:hover {
                transform: translateY(-2px);
                border-left-color: var(--bni-red);
            }

            .result-name {
                font-weight: bold;
                font-size: 1.1em;
            }

            .result-company {
                color: #666;
                font-size: 0.9em;
            }

            /* Mesa Display */
            .mesa-badge {
                position: absolute;
                top: -15px;
                right: -15px;
                background: var(--bni-red);
                color: white;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 1.2rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                transform: rotate(15deg);
                z-index: 10;
            }

            .mesa-large-display {
                font-size: 3rem;
                font-weight: 800;
                color: var(--bni-red);
                text-align: center;
                margin: 10px 0;
            }

            .mesa-label {
                font-size: 0.9rem;
                color: #555;
                text-transform: uppercase;
                letter-spacing: 1px;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <header>
            <h1>BNI Ikigai QR Scanner</h1><button id="install-btn" class="btn-install" style="display: none;">Instalar
                App</button>
        </header>
        <div class="tab-container"><button class="tab-btn active" onclick="switchTab('scan')">Escanear
                QR</button><button class="tab-btn" onclick="switchTab('search')">Buscar Nombre</button></div>
        <div id="reader"></div>
        <div id="search-container">
            <div class="search-box"><input type="text" id="search-input" class="search-input"
                    placeholder="Buscar por nombre..." onkeypress="handleEnter(event)"><button class="search-btn"
                    onclick="performSearch()">Buscar</button></div>
            <div id="loading" style="display:none; color: #666; margin-top: 10px;">Buscando...</div>
            <div id="search-results-list"></div>
        </div>
        <div id="result-container">
            <h3>C&oacute;digo Detectado</h3>
            <div id="mesa-container"
                style="display: none; padding-bottom: 15px; border-bottom: 2px dashed #eee; margin-bottom: 15px;">
                <div class="mesa-label">MESA</div>
                <div id="mesa-number" class="mesa-large-display">-</div>
            </div>
            <div id="qrResult"></div>
            <div style="display: flex; flex-direction: column; align-items: center;"><button id="approve-btn"
                    class="btn btn-approve">Confirmar Asistencia</button><button id="scan-again-btn"
                    class="btn btn-scan-again">Escanear Otro</button></div>
        </div>
        <footer>
            <p>&copy;
                2025 BNI Ikigai QR Scanner. Todos los derechos reservados.</p>
            <p>Desarrollado por Global S1</p>
            <p>Version 1.1.5</p>
        </footer>
        <script>const reader = document.getElementById('reader');
            const resultContainer = document.getElementById('result-container');
            const qrResult = document.getElementById('qrResult');
            const approveBtn = document.getElementById('approve-btn');
            const scanAgainBtn = document.getElementById('scan-again-btn');
            const installBtn = document.getElementById('install-btn');

            let scanner = null;
            let currentQrData = null;
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'block';
            });

            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();

                    const { outcome } = await deferredPrompt.userChoice;

                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                }
            });

            async function onScanSuccess(decodedText, decodedResult) {
                if (scanner) {
                    scanner.pause();
                }

                reader.style.display = 'none';

                // Show loading state
                resultContainer.innerHTML = '<div style="padding: 20px;"><h3>Buscando datos...</h3><div id="loading-scan" style="color: #666;">Por favor espere</div></div>';
                resultContainer.style.display = 'block';

                let uuid = decodedText;

                // Try to parse UUID|email|name format if exists
                if (decodedText.includes('|')) {
                    const parts = decodedText.split('|');
                    if (parts.length >= 1) {
                        uuid = parts[0];
                    }
                }

                try {
                    // Fetch details by ID
                    const response = await fetch(`https://n8n.globals.one/webhook/645c099c-de5f-4d9f-9126-06037cfd0020?ID=${uuid}`);
                    const data = await response.json();

                    if (Array.isArray(data) && data.length > 0) {
                        // Restore Result Container Structure before populating
                        restoreResultContainerStructure();
                        selectUser(data[0]);
                    } else {
                        // Fallback or Error
                        resultContainer.innerHTML = `
                            <h3>Error</h3>
                            <p>No se encontraron datos para este ID.</p>
                            <p style="font-size:0.8em; color:#999;">ID: ${uuid}</p>
                            <button id="scan-again-btn-err" class="btn btn-scan-again">Escanear Otro</button>
                        `;
                        document.getElementById('scan-again-btn-err').addEventListener('click', startScanner);
                    }
                } catch (error) {
                    console.error("Error fetching scan data:", error);
                    resultContainer.innerHTML = `
                        <h3>Error de Conexión</h3>
                        <p>No se pudo obtener la información del miembro.</p>
                        <button id="scan-again-btn-err" class="btn btn-scan-again">Intentar de nuevo</button>
                    `;
                    document.getElementById('scan-again-btn-err').addEventListener('click', startScanner);
                }
            }

            // Helper to restore the innerHTML of result-container since we overwrite it for loading
            function restoreResultContainerStructure() {
                resultContainer.innerHTML = `
                    <h3>C&oacute;digo Detectado</h3>
                    <div id="mesa-container" style="display: none; padding-bottom: 15px; border-bottom: 2px dashed #eee; margin-bottom: 15px;">
                        <div class="mesa-label">MESA</div>
                        <div id="mesa-number" class="mesa-large-display">-</div>
                    </div>
                    <div id="qrResult"></div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <button id="approve-btn" class="btn btn-approve">Confirmar Asistencia</button>
                        <button id="scan-again-btn" class="btn btn-scan-again">Escanear Otro</button>
                    </div>
                `;

                // Re-bind events because elements were recreated
                document.getElementById('approve-btn').addEventListener('click', handleApprove);
                document.getElementById('scan-again-btn').addEventListener('click', () => {
                    const isSearchMode = document.getElementById('search-container').style.display === 'flex';
                    if (isSearchMode) {
                        resultContainer.style.display = 'none';
                        document.getElementById('search-container').style.display = 'flex';
                    } else {
                        startScanner();
                    }
                });
            }

            // Extract approve logic to named function for re-binding
            async function handleApprove() {
                if (!currentQrData) return;

                const confirmed = confirm('¿Confirmar asistencia para este miembro?');

                if (confirmed) {
                    const approveBtn = document.getElementById('approve-btn');
                    const originalText = approveBtn.innerText;
                    approveBtn.innerText = 'Enviando...';
                    approveBtn.disabled = true;

                    try {
                        const response = await fetch('https://n8n.globals.one/webhook/38e19040-2814-4281-9c50-1001af13ea36', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(currentQrData),
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert('¡Asistencia registrada correctamente!');
                            currentQrData = null;
                            if (document.getElementById('search-container').style.display === 'flex') {
                                resultContainer.style.display = 'none';
                                document.getElementById('search-container').style.display = 'flex';
                            } else {
                                startScanner();
                            }
                        } else {
                            alert('Error: ' + (data.message || 'No se pudo registrar'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error de conexión al servidor');
                    } finally {
                        approveBtn.innerText = originalText;
                        approveBtn.disabled = false;
                    }
                }
            }

            function startScanner() {
                reader.style.display = 'block';
                resultContainer.style.display = 'none';
                currentQrData = null;

                if (scanner) {
                    scanner.resume();
                }
            }

            // Initial binding for existing button (though distinct from dynamic one, good to keep for safety)
            approveBtn.addEventListener('click', handleApprove);

            scanAgainBtn.addEventListener('click', () => {
                // Determine current mode
                const isSearchMode = document.getElementById('search-container').style.display === 'flex';

                if (isSearchMode) {
                    resultContainer.style.display = 'none';
                    document.getElementById('search-container').style.display = 'flex';
                }

                else {
                    startScanner();
                }
            });

            // Tab Switching Logic
            function switchTab(mode) {
                const tabs = document.querySelectorAll('.tab-btn');
                const readerDiv = document.getElementById('reader');
                const searchDiv = document.getElementById('search-container');
                const resultDiv = document.getElementById('result-container');

                resultDiv.style.display = 'none'; // Always hide result when switching tabs

                if (mode === 'scan') {
                    tabs[0].classList.add('active');
                    tabs[1].classList.remove('active');
                    readerDiv.style.display = 'block';
                    searchDiv.style.display = 'none';

                    if (scanner) {
                        scanner.resume();
                    }
                }

                else {
                    tabs[0].classList.remove('active');
                    tabs[1].classList.add('active');
                    readerDiv.style.display = 'none';
                    searchDiv.style.display = 'flex';

                    if (scanner) {
                        scanner.pause();
                    }
                }
            }

            // Search Logic
            function handleEnter(e) {
                if (e.key === 'Enter') performSearch();
            }

            async function performSearch() {
                const query = document.getElementById('search-input').value.trim();
                const list = document.getElementById('search-results-list');
                const loading = document.getElementById('loading');

                if (!query) return;

                list.innerHTML = '';
                loading.style.display = 'block';

                try {
                    const response = await fetch(`https://n8n.globals.one/webhook/645c099c-de5f-4d9f-9126-06037cfd0020?name=${encodeURIComponent(query)}`);
                    const data = await response.json(); // Array of users

                    loading.style.display = 'none';

                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(user => {
                            const item = document.createElement('div');
                            item.className = 'result-item';

                            item.innerHTML = `<div class="result-name" >${user.Nombre}</div> <div class="result-company" >${user.Empresa}</div> `;
                            item.onclick = () => selectUser(user);
                            list.appendChild(item);
                        });
                    }

                    else {
                        list.innerHTML = '<div style="text-align:center; padding:20px;">No se encontraron resultados</div>';
                    }

                }

                catch (error) {
                    console.error("Error searching:", error);
                    loading.style.display = 'none';
                    list.innerHTML = '<div style="color:red; text-align:center;">Error al buscar</div>';
                }
            }

            function selectUser(user) {

                // Map user data to currentQrData format expected by the approve button
                // Expected: uuid, email, name
                currentQrData = {
                    uuid: user.ID,
                    email: user.Correo || 'No email',
                    name: user.Nombre
                }

                    ;

                // Populate Result View
                const qrResultDiv = document.getElementById('qrResult');
                const mesaContainer = document.getElementById('mesa-container');
                const mesaNumber = document.getElementById('mesa-number');

                // Fill details
                qrResultDiv.innerHTML = `<div style="margin-bottom: 8px;" ><strong>Nombre:</strong> <span style="font-size: 1.1em;" >${user.Nombre}</span></div> <div style="margin-bottom: 8px;" ><strong>Empresa:</strong>${user.Empresa}</div> <div style="margin-bottom: 8px;" ><strong>Email:</strong>${user.Correo}</div> <div style="font-size: 0.8em; color: #777;" ><strong>ID:</strong>${user.ID}</div> `;

                // Show Mesa if available
                if (user.Mesa) {
                    mesaContainer.style.display = 'block';
                    mesaNumber.textContent = user.Mesa;
                }

                else {
                    mesaContainer.style.display = 'none';
                }

                // Switch view
                document.getElementById('search-container').style.display = 'none';
                document.getElementById('result-container').style.display = 'block';
            }


            scanner = new Html5QrcodeScanner("reader", {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                rememberLastUsedCamera: true,
                aspectRatio: 1.0
            }, false);

            scanner.render(onScanSuccess);
        </script>
    </body>

</html>